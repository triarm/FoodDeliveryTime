---
title: "Food Delivery Time"
author: "Tria Rahmat Mauludin"
date: "2/25/2022"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE,
                      message = FALSE)
```

# Import Library
```{r}
library(dplyr)
library(tidyverse)
library(tidymodels)
```

# Import Data
```{r}
library(readxl)
train_data <- read_excel("./dataset/Data_Train.xlsx")
test_data <- read_excel("./dataset/Data_Test.xlsx")
head(train_data)
```

# Preprocess Data
```{r}
str(train_data)
```
## Location
Find the unique location:
```{r}
unique(train_data$Location)
```
From the result above, we will generalized the location by the city (the words after last comma).
- "Mumbai", "Mumbai CST Area" , "Mumbai Central" -> "Mumbai"
- "Bangalore", "Electronic City", "Marathalli", "Whitefield" -> "Bangalore"
- "India Gate", "Delhi", "Delhi University-GTB Nagar", "Delhi Cantt." , "Timarpur", "Noida" -> "Delhi"
- "Gurgoan", "Gurgaon" -> "Gurgaon"
- "Kolkata" -> "Kolkata"
- "Maharashtra", "Pune", "Pune University" -> "Maharashtra"
- "Hyderabad", "Begumpet", "Majestic" -> "Hyderabad"
```{r}
#train_data$Location <- word(train_data$Location, -1, sep=",") %>% trimws() #%>% 
#train_data$Location[train_data$Location %in% c("Mumbai", "Mumbai CST Area" , "Mumbai Central")] <- "Mumbai"
#train_data$Location[train_data$Location %in% c("Bangalore", "Electronic City", "Marathalli", "Whitefield")] <- "Bangalore"
#train_data$Location[train_data$Location %in% c("India Gate", "Delhi", "Delhi University-GTB Nagar", "Delhi Cantt." , "Timarpur", "Noida")] <- "Delhi"
#train_data$Location[train_data$Location %in% c("Gurgoan", "Gurgaon")] <- "Gurgaon"
#train_data$Location[train_data$Location %in% c("Maharashtra", "Pune", "Pune University")] <- "Maharashtra"
#train_data$Location[train_data$Location %in% c("Hyderabad", "Begumpet", "Majestic")] <- "Hyderabad"
```

After that, we change the type of Location into factor
```{r}
#train_data <- train_data %>% 
#  mutate(Location = as.factor(Location))
str(train_data)
```

## Cuisines
```{r}
unique(train_data$Cuisines)[1:10]
```
From result above, one delivery order can contained some types of cuisines. We will doing One-Hot Encoding for every cuisines type.
```{r}
library(splitstackshape)
splitstackshape:::charMat(strsplit(train_data$Cuisines, ", "), fill = 0L)
```
## Average Cost
```{r}
unique(train_data$Average_Cost)
```
We will remove the string `\u20b9` and ',' in every data then change it to numeric type.
```{r}
library(stringr)
gsub('[\u20b9]|,', '', train_data$Average_Cost) %>% as.numeric() %>% 
  unique()
```
## Minumum Order
```{r}
unique(train_data$Minimum_Order)
```
We will preprocess the minimum order with the method as same as the average cost
```{r}
gsub('[\u20b9]|,', '', train_data$Minimum_Order) %>% as.numeric() %>% 
  unique()
```
## Rating
```{r}
unique(train_data$Rating)
```
We will convert as numeric. If the Rating is `NEW`, `Opening Soon`, `Temporarily Closed`, or `-` we will change to NA.
```{r}
train_data$Rating %>% as.numeric() %>% unique()
```
## Votes
```{r}
unique(train_data$Votes)
```
We will convert as numeric.
```{r}
train_data$Votes %>% as.numeric %>% unique()
```
## Reviews
```{r}
unique(train_data$Reviews)
```
We will convert as numeric.
```{r}
train_data$Reviews %>% as.numeric %>% unique()
```
## Delivery Times
```{r}
unique(train_data$Delivery_Time)
```
We will remove the " minutes" then convert it to numeric
```{r}
gsub('[ minutes]', '', train_data$Delivery_Time) %>%  as.numeric() %>% unique()
```
Splitting data into train_data and validation_data
```{r}
set.seed(100)

splitted <- initial_split(train_data, prop = 0.8, strata = 'Delivery_Time')
splitted
```
```{r}
training(splitted)
```

# Pipeline using tidymodels
```{r}
transform_location <- function(Location){
  if(Location %in% c("Mumbai", "Mumbai CST Area" , "Mumbai Central")){
    return ("Mumbai")
  } else if(Location %in% c("Bangalore", "Electronic City", "Marathalli", "Whitefield")){
    return("Bangalore")
  } else if(Location %in% c("India Gate", "Delhi", "Delhi University-GTB Nagar", "Delhi Cantt." , "Timarpur", "Noida")){
    return("Delhi")
  } else if(Location %in% c("Gurgoan", "Gurgaon")){
    return("Gurgaon")
  } else if(Location %in% c("Maharashtra", "Pune", "Pune University")){
    return("Maharashtra")
  } else if(Location %in% c("Hyderabad", "Begumpet", "Majestic")){
    return("Hyderabad")
  } else if(Location %in% c("Kolkata")){
    return("Kolkata")
  }
}
rec <- recipe(Delivery_Time~., data = training(splitted)) %>% 
  step_select(-Restaurant) %>% 
  step_mutate(
    Location =  word(Location, -1, sep=",") %>% trimws() %>% sapply(function(x) transform_location(x)),
    Average_Cost = gsub('[\u20b9]|,', '', Average_Cost) %>% as.numeric(),
    Minimum_Order = gsub('[\u20b9]|,', '', Minimum_Order) %>% as.numeric(),
    Rating = as.character(Rating) %>% as.numeric(),
    Votes = as.character(Votes) %>% as.numeric(),
    Reviews = as.character(Reviews) %>% as.numeric(),
    Delivery_Time = gsub('[ minutes]', '', Delivery_Time) %>%  as.factor()
  ) %>% 
  step_dummy_extract(Cuisines, sep= ", ") %>%
  step_naomit(everything()) %>% 
  prep()
```

```{r}
data_train <- juice(rec)
data_validation <- bake(rec, testing(splitted))
head(data_train)
head(data_validation)
```
```{r}
any(is.na(data_train))
any(is.na(data_validation))
```
# Modeling
## Regression Linear Model
```{r}
reg_model <- linear_reg(mode = "regression",
                        engine = "lm") %>% 
              fit(formula=Delivery_Time ~ Location + Average_Cost + Minimum_Order + Rating + Votes + Reviews,
                  data=data_train)
reg_model
```
## Nultinomial Regression
```{r}
library(nnet)
multi_model <- multinom_reg(mode = "classification",
                            engine = "nnet") %>% 
                fit(formula=Delivery_Time ~ .,
                  data=data_train, size = 10, maxit=100)
```

```{r}
data_validation %>% 
  select(Delivery_Time) %>% 
  bind_cols(predict(multi_model, new_data=data_validation)) %>% 
  accuracy(truth = Delivery_Time, .pred_class)
```

```{r}
library(stringr)
clean_data <- train_data %>%
              mutate(
                Location = as.factor(Location),
                Average_Cost = gsub('[\u20b9]|,', '', Average_Cost) %>% 
                  as.numeric(),
                Minimum_Order = gsub('[\u20b9]|,', '', Minimum_Order) %>% 
                  as.numeric(),
                #Rating = replace(Rating, (Rating =="-" |Rating == "NEW"), "0") %>% as.numeric(Rating),
                #Votes = replace(Votes, Votes == "-", "0") %>% as.numeric(Votes),
                #Reviews = replace(Reviews, Reviews == "-", "0") %>% as.numeric(Reviews),
                Rating = as.numeric(Rating),
                Votes = as.numeric(Votes),
                Reviews = as.numeric(Reviews),
                Delivery_Time = gsub('[ minutes]', '', Delivery_Time) %>% 
                  as.numeric()
              ) %>%
              na.omit()
clean_data
```
```{r}
cuisines <- splitstackshape:::charMat(strsplit(clean_data$Cuisines, ", "), fill = "0") %>% 
  as.data.frame(., stringsAsFactors = TRUE)

cuisines2 <- splitstackshape:::charMat(strsplit(clean_data$Cuisines, ", "), fill = 0) %>% 
  as.data.frame(.)

cuisines2 <- as.data.frame(colSums(cuisines2), )
colnames(cuisines2) <- c("Freq")
cuisines2[order(cuisines2$Freq),]
#cbind(clean_data, cuisines)
```



```{r}
clean_data %>% 
  cbind(., cuisines) %>% 
  select(-c(Restaurant, Cuisines))
```

```{r}
colSums(is.na(clean_data))
```
```{r}
cor(clean_data[,sapply(clean_data, is.numeric)])
```
```{r}
str(clean_data)
```

```{r}
model1 <- glm(formula = Delivery_Time~Location+Average_Cost+Rating+Votes+Reviews, data = clean_data, family = Gamma)
summary(model1)
```

```{r}
hist(clean_data$Delivery_Time)
```